
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://checkroth.com/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://checkroth.com/theme/pygments/colorful.min.css">
  <link rel="stylesheet" type="text/css" href="https://checkroth.com/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://checkroth.com/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://checkroth.com/theme/font-awesome/css/solid.css">

    <link href="https://checkroth.com/static/custom.css" rel="stylesheet">




<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-136401999-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#FFFFFF">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#FFFFFF">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#FFFFFF">

<meta name="author" content="Charles Heckroth" />
<meta name="description" content="This post is mostly meant as a reminder to myself in case I&#39;m in a position where I have to set it all up again. Setting up a new server from scratch can be particularly annoying when you have to remember all of the minor configuration steps you figured out …" />
<meta name="keywords" content="linux, ubuntuserver, selfhosting, plex, grafana, prometheus">

<meta property="og:site_name" content="software-and-stuff"/>
<meta property="og:title" content="Setting up a Self-Hosted Server"/>
<meta property="og:description" content="This post is mostly meant as a reminder to myself in case I&#39;m in a position where I have to set it all up again. Setting up a new server from scratch can be particularly annoying when you have to remember all of the minor configuration steps you figured out …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://checkroth.com/self-hosted-server.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2021-04-30 00:00:00+09:00"/>
<meta property="article:modified_time" content="2021-04-30 00:00:00+09:00"/>
<meta property="article:author" content="https://checkroth.com/author/charles-heckroth.html">
<meta property="article:section" content="blog"/>
<meta property="article:tag" content="linux"/>
<meta property="article:tag" content="ubuntuserver"/>
<meta property="article:tag" content="selfhosting"/>
<meta property="article:tag" content="plex"/>
<meta property="article:tag" content="grafana"/>
<meta property="article:tag" content="prometheus"/>
<meta property="og:image" content="/images/me.jpg">

  <title>software-and-stuff &ndash; Setting up a Self-Hosted Server</title>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-3090577057275093",
      enable_page_level_ads: true
    });
  </script>
</head>
<body>
  <aside>
    <div>
      <a href="https://checkroth.com">
        <img src="/images/me.jpg" alt="Charles Henry Heckroth" title="Charles Henry Heckroth">
      </a>
      <h1><a href="https://checkroth.com">Charles Henry Heckroth</a></h1>

<p>My Notes & Blog</p>
      <nav>
        <ul class="list">
          <li><a href="https://checkroth.com/pages/about-me.html">About Me</a></li>

          <li><a href="https://checkroth.com/category/blog.html" target="_blank">Blog</a></li>
          <li><a href="https://drive.google.com/file/d/1HLklPEKD8CMGnUfddLsOewxYlIfioJxq/view" target="_blank">Resume</a></li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-envelope" href="mailto:checkroth@gmail.com" target="_blank">
            <i class="fas fa-envelope">
            </i>
          </a></li>
          <li>
            <a  class="sc-github" href="https://www.github.com/Checkroth" target="_blank">
            <i class="fab fa-github">
            </i>
          </a></li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/charlesheckroth" target="_blank">
            <i class="fab fa-linkedin">
            </i>
          </a></li>
          <li>
            <a  class="sc-twitter" href="http://www.twitter.com/checkroth" target="_blank">
            <i class="fab fa-twitter">
            </i>
          </a></li>
          <li>
            <a  class="sc-stack-overflow" href="https://stackoverflow.com/users/1037971/charles" target="_blank">
            <i class="fab fa-stack-overflow">
            </i>
          </a></li>
      </ul>
    </div>

      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <ins class="adsbygoogle ads-aside"
           data-ad-client="ca-pub-3090577057275093"
           data-ad-slot="7734708573"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>

  </aside>
  <main>

    <nav>
      <a href="https://checkroth.com">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="self-hosted-server">Setting up a Self-Hosted Server</h1>
    <p>
          Posted on April 30, 2021 in <a href="https://checkroth.com/category/blog.html">blog</a>


    </p>
  </header>


  <div>
    <p>This post is mostly meant as a reminder to myself in case I'm in a position where I have to set it all up again.</p>
<p>Setting up a new server from scratch can be particularly annoying when you have to remember all of the minor configuration steps you figured out by trial-and-error. This is a record of some of those steps to make it easier for myself in the future, and for anybody else who might be interested.</p>
<h1 id="requirements-and-outline"><a href="#requirements-and-outline">Requirements and Outline</a></h1>
<h2 id="tools-used"><a href="#tools-used">Tools used</a></h2>
<p>1) A computer</p>
<p>I built this: https://pcpartpicker.com/user/checkroth/saved/#view=cThqmG</p>
<p>But you could really use anything.</p>
<p>2) 2 USB thumb drives at least 4GB each.</p>
<p>2.a One Should have <a href="https://ubuntu.com/download/server">ubuntu server</a> installation medium.</p>
<p>2.b The other should have a <a href="https://ubuntu.com/tutorials/create-a-usb-stick-on-ubuntu#1-overview">live usb</a>. This is generally useful if you run in to trouble at any point.</p>
<h2 id="overall-process"><a href="#overall-process">Overall Process</a></h2>
<p>The simple steps overview is:</p>
<ol>
<li>Build a computer</li>
<li>Partition and format your hardrive either with a live usb or from the server installer</li>
<li>Install ubuntu server</li>
<li>Set up networking</li>
<li>Set up desired software (plex, grafana, etc.)</li>
</ol>
<h1 id="system-setup_1"><a href="#system-setup">System Setup</a></h1>
<h2 id="preparation"><a href="#preparation">Preparation</a></h2>
<p>My goal was primarily to have a plex server to serve my music and video collection that's been bouncing between various storage and streaming services for the past ten years.</p>
<p>As such, my server required a lot of space, but I wanted to keep the operating system itself separate from the server. So I made a ~120GB partition in my 2TB hard drive using <a href="https://gparted.org/">gparted</a> off of my live usb. The rest is formatted to simply store plex media.</p>
<p>I recommend doing something similar to this if you have a lot of storage space, as eventually you will want to <a href="https://askubuntu.com/a/741727/509039">move your operating system</a>, and having just the essentials during that process makes things a lot easier. </p>
<h2 id="installation"><a href="#installation">Installation</a></h2>
<p>Make sure you have an ethernet connection before starting, even if you ultimately want to use Wi-Fi
Straightforward. Boot from the ubuntu server install usb and follow the interactive steps.</p>
<h2 id="networking"><a href="#networking">Networking</a></h2>
<p>In case you have a wifi card on your server, the following must be done</p>
<p>Install wpa_supplicant, and then register your wifi:</p>
<p><code>wpa_passphrase ESSID passphrase | sudo tee /etc/wpa_supplicant.conf</code></p>
<p>where ESSID is the name of your wifi network. This is the name of the network when you connect on any device, like your phone. If you don't have such a device available you can list them with the following steps:</p>
<ul>
<li>install network-manager with <code>apt install network-manager</code></li>
<li>run <code>nmcli dev wifi</code></li>
</ul>
<p>If your network is unbroadcasted, add <code>scan_ssid=1</code> to the bottom of the network object you just created in <code>etc/wpa_supplicant.conf</code>.</p>
<p>If you want to go <em>only</em> on WiFi, you may want to mark ethernet as optional in <code>/etc/netplan/00-installer-config.yaml</code>. If you don't do this, your server start will slow down significantly while it waits the default amount of time for your network to connect (probably around 90 seocnds).</p>
<p>My config looks like the following:</p>
<div class="highlight"><pre><span></span># This is the network config written by 'subiquity'
network:
  ethernets:
    enp8s0:
      optional: true
      dhcp4: true
  version: 2
  wifis:
    wlp6s0:
      access-points:
        "mywifiESSID":
          password: "mywifipassword"
      dhcp4: true
</pre></div>
<h2 id="finding-your-ipv4"><a href="#finding-your-ipv4">Finding your IPv4</a></h2>
<h3 id="private"><a href="#private">private</a></h3>
<p>run <code>ifconfig</code>.</p>
<p>Ignore entires like <code>127.0.0.1</code></p>
<p>Your private network IP address should be something like <code>192.168.1.123</code>.</p>
<h3 id="public"><a href="#public">public</a></h3>
<p>Your public IP address will be necessary for a lot of things, most notable the following "Going Remote" step.</p>
<p>It can be surprisingly difficult to find your outgoing IPV4 address through cli tools, depending on your router/modem setup.</p>
<p>Just hit <code>curl https://ipinfo.io/ip</code> to get your public IP.</p>
<h2 id="going-remote_1"><a href="#going-remote">Going Remote</a></h2>
<p>If you're anything like me, the first thing you'll want to do once your server is running is... stop interacting with your server directly.</p>
<p>Your new ubuntu server should already be ssh-ready. Simply ensure that you are on the same local network as your server and then ssh to its private network IP address, or use the public IP if you aren't on the same network as the server.</p>
<p>You need the username you created when spinning up your server.</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span><span class="w"> </span><span class="n">myserveradmin</span><span class="mf">@192.168.1.123</span>
</pre></div>
<p>If that works, exit back to your host machine and run</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span><span class="o">-</span><span class="k">copy</span><span class="o">-</span><span class="kt">id</span><span class="w">  </span><span class="n">myserveradmin</span><span class="mf">@192.168.1.123</span>
</pre></div>
<p>And now you should be able to access your server over SSH from your local network without a password!</p>
<h3 id="making-it-even-easier"><a href="#making-it-even-easier">Making it even easier</a></h3>
<p>If you gave a name to your new server as many nerds are want to do, you might want to be able to communicate with it with just that name!</p>
<p>Assuming my server user name is <code>myserveradmin</code> from above, and you named your server <code>DopeServer</code>, add the following to your host's <code>~/.ssh/config</code></p>
<div class="highlight"><pre><span></span>Host dopeserver
    User myserveradmin
    HostName 192.168.1.123
</pre></div>
<p>Now you can get in with just <code>ssh dopeserver</code></p>
<h1 id="software_2"><a href="#software">Software</a></h1>
<p>Details for how to set up my most heavily used software packages for the new server.</p>
<h2 id="plex"><a href="#plex">Plex</a></h2>
<p>Download <a href="https://www.plex.tv/media-server-downloads/">plexmediaserver</a>.</p>
<p>You can either copy the link that this page takes you to, and paste it over in your server with <code>wget copiedlink</code>, or you can just scp. If you did the 「Going Remote」 section above, it should be as simple as:</p>
<ul>
<li>Download the latest version of plexmediaserver, something like <code>plexmediaserver_1.22.3.4392-d7c624def_amd64.deb</code></li>
<li>Copy the file to your server with <code>scp plexmediaserver_1.22.3.4392-d7c624def_amd64.deb dopeserver:</code></li>
</ul>
<p>Then you just install with dpkg on the server, <code>sudo dpkg -i plexmediaserver_1.22.3.4392-d7c624def_amd64.deb</code>.</p>
<p>You should be able to see plex running with <code>systemctl status plexmediaserver</code>, and you should be able to see it from your main computer using the private network IP address on port 32400, <code>http://192.168.1.123:32400/</code></p>
<h2 id="metrics"><a href="#metrics">Metrics</a></h2>
<p>For all parts below, keep the following in mind:</p>
<ul>
<li>For downloading you can use <code>wget</code> or you can download via browser and SCP as outlined under Plex.</li>
<li>All the filenames/dates I'm using are of the current version at-time-of-writing. They may be different, please check the linked release pages.</li>
<li>I am using the <code>/opt</code> directory just because I prefer it, as it helps be keep track of which services I am manually managing. Most guides will tell you to use <code>/etc</code> and that's fine too.</li>
<li>I create a user for each service. This isn't strictly necessary.</li>
</ul>
<h3 id="node-exporter"><a href="#node-exporter">Node Exporter</a></h3>
<p>Note: There are lots of other exporters. I recommend adding whatever piques your interest.</p>
<p><a href="https://prometheus.io/download/#node_exporter">Download node_exporter</a></p>
<div class="highlight"><pre><span></span><span class="c1"># Download, extract, move</span>
<span class="n">wget</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">node_exporter</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mf">1.2</span><span class="o">/</span><span class="n">node_exporter</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mf">2.</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">tar</span><span class="w"> </span><span class="o">-</span><span class="n">xzvf</span><span class="w"> </span><span class="n">node_exporter</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mf">2.</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">mv</span><span class="w"> </span><span class="n">node_exporter</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mf">2.</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="o">/</span><span class="n">node_exporter</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span>

<span class="c1"># Set permissions</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">useradd</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">create</span><span class="o">-</span><span class="n">home</span><span class="w"> </span><span class="o">--</span><span class="n">shell</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="bp">false</span><span class="w"> </span><span class="n">node_exporter</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">chown</span><span class="w"> </span><span class="n">node_exporter</span><span class="p">:</span><span class="n">node_exporter</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">node_exporter</span>
</pre></div>
<p>Next you want to make a systemd service for node exporter</p>
<p>Place the following in a new file: /etc/systemd/system/node_exporter.service</p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Node Exporter</span>
<span class="na">Wants</span><span class="o">=</span><span class="s">network-online.target</span>
<span class="na">After</span><span class="o">=</span><span class="s">network-online.target</span>

<span class="k">[Service]</span>
<span class="na">User</span><span class="o">=</span><span class="s">node_exporter</span>
<span class="na">Group</span><span class="o">=</span><span class="s">node_exporter</span>
<span class="na">Type</span><span class="o">=</span><span class="s">simple</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/opt/node_exporter --collector.systemd</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>
<p>And then run it:</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">node_exporter</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">node_exporter</span>
</pre></div>
<p>You should now see node exporter on your local network ip at port 9100, <code>http://192.168.1.123:9100/</code></p>
<h3 id="prometheus"><a href="#prometheus">Prometheus</a></h3>
<p><a href="https://prometheus.io/download/">Download prometheus</a></p>
<div class="highlight"><pre><span></span><span class="c1"># Download, extract, move</span>
<span class="n">wget</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="mf">26.0</span><span class="o">/</span><span class="n">prometheus</span><span class="o">-</span><span class="mf">2.26</span><span class="o">.</span><span class="mf">0.</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">tar</span><span class="w"> </span><span class="o">-</span><span class="n">xzvf</span><span class="w"> </span><span class="n">node_exporter</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mf">2.</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="c1"># This is renaming the folder, not putting the prometheus-2.26.0.linux-amd64 folder as a subfolder under /opt/prometheus/prometheus-2.26.0.linux-amd64.</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">mv</span><span class="w"> </span><span class="n">prometheus</span><span class="o">-</span><span class="mf">2.26</span><span class="o">.</span><span class="mf">0.</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">prometheus</span>

<span class="c1"># Set permissions</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">useradd</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">create</span><span class="o">-</span><span class="n">home</span><span class="w"> </span><span class="o">--</span><span class="n">shell</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="bp">false</span><span class="w"> </span><span class="n">prometheus</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">chown</span><span class="w"> </span><span class="n">prometheus</span><span class="p">:</span><span class="n">prometheus</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">prometheus</span>
</pre></div>
<p>You really only need the <code>prometheus</code> and <code>prometheus.yml</code> files. But you can just move everything, its not that much.</p>
<p>Next you want to edit the yaml file you copied to include any targets you have added. I'll be including node exporter from the last step, as well as node exporter that I already have running on my main machine.</p>
<p>The main portion of this file is exactly what was in <code>prometheus.yml</code>, I have just added two scrape configs at the bottom.</p>
<div class="highlight"><pre><span></span><span class="c1"># my global config</span>
<span class="nt">global</span><span class="p">:</span>
<span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w">     </span><span class="l l-Scalar l-Scalar-Plain">15s</span><span class="w"> </span><span class="c1"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span>
<span class="w">  </span><span class="nt">evaluation_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15s</span><span class="w"> </span><span class="c1"># Evaluate rules every 15 seconds. The default is every 1 minute.</span>
<span class="w">  </span><span class="c1"># scrape_timeout is set to the global default (10s).</span>

<span class="c1"># Alertmanager configuration</span>
<span class="nt">alerting</span><span class="p">:</span>
<span class="w">  </span><span class="nt">alertmanagers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># - alertmanager:9093</span>

<span class="c1"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span>
<span class="nt">rule_files</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># - "first_rules.yml"</span>
<span class="w">  </span><span class="c1"># - "second_rules.yml"</span>

<span class="c1"># A scrape configuration containing exactly one endpoint to scrape:</span>
<span class="c1"># Here it's Prometheus itself.</span>
<span class="nt">scrape_configs</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">'prometheus'</span>

<span class="w">    </span><span class="c1"># metrics_path defaults to '/metrics'</span>
<span class="w">    </span><span class="c1"># scheme defaults to 'http'.</span>

<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'localhost:9090'</span><span class="p p-Indicator">]</span>

<span class="w">  </span><span class="c1"># These are the bits you add</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s">'dopeserver'</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'localhost:9100'</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dopepersonalpc</span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">'192.168.1.124:9100'</span><span class="p p-Indicator">]</span>
</pre></div>
<p>Finally, you need a systemd service for this one too.</p>
<p>This goes in <code>/etc/systemd/system/prometheus.service</code></p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Prometheus</span>
<span class="na">Wants</span><span class="o">=</span><span class="s">network-online.target</span>
<span class="na">After</span><span class="o">=</span><span class="s">network-online.target</span>

<span class="k">[Service]</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/opt</span>
<span class="na">User</span><span class="o">=</span><span class="s">prometheus</span>
<span class="na">Group</span><span class="o">=</span><span class="s">prometheus</span>
<span class="na">Type</span><span class="o">=</span><span class="s">simple</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/opt/prometheus </span>\
<span class="w">    </span><span class="s">--config.file /opt/prometheus.yml</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>
<p>And, enable &amp; start</p>
<div class="highlight"><pre><span></span>sudo systemctl enable prometheus
sudo syetemctl start prometheus
</pre></div>
<p>You should now see node exporter on your local network ip at port 9090, <code>http://192.168.1.123:9090/</code></p>
<h3 id="grafana"><a href="#grafana">Grafana</a></h3>
<p>You can install grafana enterprise. Its the same as the free version with the paywalled features in the package, but you can just leave those behind the paywall.</p>
<p>Following the Grafana installation guide:</p>
<div class="highlight"><pre><span></span><span class="nx">echo</span><span class="w"> </span><span class="s">"deb https://packages.grafana.com/enterprise/deb stable main"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">sudo</span><span class="w"> </span><span class="nx">tee</span><span class="w"> </span><span class="o">-</span><span class="nx">a</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">apt</span><span class="o">/</span><span class="nx">sources</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">d</span><span class="o">/</span><span class="nx">grafana</span><span class="p">.</span><span class="nx">list</span>
<span class="nx">sudo</span><span class="w"> </span><span class="nx">apt</span><span class="w"> </span><span class="nx">update</span>
<span class="nx">sudo</span><span class="w"> </span><span class="nx">apt</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">grafana</span><span class="o">-</span><span class="nx">enterprise</span>
</pre></div>
<p>There may be a plugin there (it is for me, sometimes) that breaks grafana. You want to remove it (or move it to a persisted trash, just in case)</p>
<div class="highlight"><pre><span></span>sudo mv /usr/share/grafana/plugins-bundled/gel-0.6.0/ ~/trash/
</pre></div>
<p>And enable &amp; start</p>
<div class="highlight"><pre><span></span>sudo systemctl enable grafana-server
sudo systemctl start grafana-server
</pre></div>
<p>You should now see node exporter on your local network ip at port 3000, <code>http://192.168.1.123:3000/</code></p>
<p>You may want to set the password or reconfigure. The configuraiton lives in <code>/etc/grafana/grafana.ini</code>.</p>
<p>You can change things like the port, admin_password, or setup SSL or a custom domain here. More details in a future post.</p>
<p>Now that you have grafana, prometheus, and node_exporter running, you'll want to set up your first dashboard.</p>
<p>In grafana, 
- add a data source for your local prometheus (you don't need the private network IP, just <code>0.0.0.0:9090</code>)
- Go to +(Create) -&gt; Import -&gt; Pop the Node Exporter Full dashboard in there: https://grafana.com/grafana/dashboards/1860</p>
<p>Now you should have real-time metrics for your server!</p>
<h2 id="logging_1"><a href="#logging">Logging</a></h2>
<h3 id="promtail"><a href="#promtail">Promtail</a></h3>
<p>Promtail is necessary to get your logs in to Loki and Grafana.</p>
<p><a href="https://github.com/grafana/loki/releases">Download promtail</a></p>
<div class="highlight"><pre><span></span><span class="n">wget</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">grafana</span><span class="o">/</span><span class="n">loki</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="mf">2.1</span><span class="o">/</span><span class="n">promtail</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">zip</span>
<span class="mi">7</span><span class="n">z</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">promtail</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">zip</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">mv</span><span class="w"> </span><span class="n">promtail</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">promtail</span>
</pre></div>
<p>Promtail default configuration is kind of hard to come by. Mine looks like this, at /opt/promtail.yml:</p>
<div class="highlight"><pre><span></span><span class="n">server</span><span class="o">:</span>
<span class="w">  </span><span class="n">http_listen_port</span><span class="o">:</span><span class="w"> </span><span class="mi">9080</span>
<span class="w">  </span><span class="n">grpc_listen_port</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span>

<span class="n">positions</span><span class="o">:</span>
<span class="w">  </span><span class="n">filename</span><span class="o">:</span><span class="w"> </span><span class="sr">/tmp/</span><span class="n">positions</span><span class="o">.</span><span class="na">yaml</span>

<span class="n">clients</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">url</span><span class="o">:</span><span class="w"> </span><span class="n">http</span><span class="o">://</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">3100</span><span class="sr">/loki/api/v1/</span><span class="n">push</span>

<span class="n">scrape_configs</span><span class="o">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">job_name</span><span class="o">:</span><span class="w"> </span><span class="n">plex</span>
<span class="w">    </span><span class="n">static_configs</span><span class="o">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">targets</span><span class="o">:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="n">localhost</span>
<span class="w">        </span><span class="n">labels</span><span class="o">:</span>
<span class="w">          </span><span class="n">job</span><span class="o">:</span><span class="w"> </span><span class="n">plex</span>
<span class="w">          </span><span class="n">__path__</span><span class="o">:</span><span class="w"> </span><span class="sr">/var/lib/plexmediaserver/Library/Application\ Support/Plex\ Media\ Server/Logs/</span><span class="o">*</span><span class="n">log</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">job_name</span><span class="o">:</span><span class="w"> </span><span class="n">nginx</span>
<span class="w">    </span><span class="n">pipeline_stages</span><span class="o">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">replace</span><span class="o">:</span>
<span class="w">          </span><span class="n">expression</span><span class="o">:</span><span class="w"> </span><span class="s1">'(?:[0-9]{1,3}\.){3}([0-9]{1,3})'</span>
<span class="w">          </span><span class="n">replace</span><span class="o">:</span><span class="w"> </span><span class="s1">'***'</span>
<span class="w">    </span><span class="n">static_configs</span><span class="o">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">targets</span><span class="o">:</span>
<span class="w">         </span><span class="o">-</span><span class="w"> </span><span class="n">localhost</span>
<span class="w">        </span><span class="n">labels</span><span class="o">:</span>
<span class="w">          </span><span class="n">job</span><span class="o">:</span><span class="w"> </span><span class="n">nginx_access_log</span>
<span class="w">          </span><span class="n">host</span><span class="o">:</span><span class="w"> </span><span class="n">canvas</span>
<span class="w">          </span><span class="n">agent</span><span class="o">:</span><span class="w"> </span><span class="n">promtail</span>
<span class="w">          </span><span class="n">__path__</span><span class="o">:</span><span class="w"> </span><span class="sr">/var/log/nginx/</span><span class="o">*</span><span class="n">access</span><span class="o">.</span><span class="na">log</span>
</pre></div>
<p>Note that my nginx access logs are set up to be compatible with <a href="https://grafana.com/grafana/dashboards/12559">this dashboard</a></p>
<p>And you need a service. This one doesn't have its own user group because it needs access to system logs.</p>
<p>The following would go in <code>/etc/systemd/system/promtail.service</code></p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Promtail</span>
<span class="na">Wants</span><span class="o">=</span><span class="s">network-online.target</span>
<span class="na">After</span><span class="o">=</span><span class="s">network-online.target</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">simple</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/opt/promtail -config.file /opt/promtail.yml</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>
<h3 id="loki"><a href="#loki">Loki</a></h3>
<p>Grafana Loki is a nice way to get your logs from journalctl and plex in to Grafana, so you can play around with those. It will also be useful when you want to do more with your server in the future, like run a website or some application.</p>
<p>Following the grafana loki installation guide found <a href="https://grafana.com/docs/loki/latest/installation/local/">here</a></p>
<div class="highlight"><pre><span></span><span class="c1"># Get and extract loki</span>
<span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="s2">"https://github.com/grafana/loki/releases/download/v2.2.1/loki-linux-amd64.zip"</span>
<span class="n">unzip</span><span class="w"> </span><span class="n">loki</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">zip</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">mv</span><span class="w"> </span><span class="n">loki</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">loki</span>

<span class="c1"># Get basic config</span>
<span class="n">wget</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">grafana</span><span class="o">/</span><span class="n">loki</span><span class="o">/</span><span class="k">master</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">loki</span><span class="o">/</span><span class="n">loki</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">mv</span><span class="w"> </span><span class="n">loki</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">yaml</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">loki</span><span class="o">.</span><span class="n">yaml</span>

<span class="c1"># Set permissions</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">chown</span><span class="w"> </span><span class="n">prometheus</span><span class="p">:</span><span class="n">prometheus</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">prometheus</span><span class="o">.</span><span class="n">yml</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">chown</span><span class="w"> </span><span class="n">prometheus</span><span class="p">:</span><span class="n">prometheus</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">prometheus</span>
</pre></div>
<p>I just use the default loki config with no changes.</p>
<p>Next, you need to add the service. I just share prometheus permissions with this one.</p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Loki</span>
<span class="na">Wants</span><span class="o">=</span><span class="s">network-online.target</span>
<span class="na">After</span><span class="o">=</span><span class="s">network-online.target</span>

<span class="k">[Service]</span>
<span class="na">User</span><span class="o">=</span><span class="s">prometheus</span>
<span class="na">Group</span><span class="o">=</span><span class="s">prometheus</span>
<span class="na">Type</span><span class="o">=</span><span class="s">simple</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/opt/loki -config.file /opt/loki.yml</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>
<h1 id="in-summary_2"><a href="#in-summary">In Summary</a></h1>
<p>This guide is meant mostly as a self-refernce, but I hope it is helpful to anybody trying to start their own local server.</p>
<p>The general software I use on my server are:</p>
<ul>
<li>Grafana</li>
<li>Promtail</li>
<li>Loki</li>
<li>Prometheus</li>
<li>Node Exporter</li>
<li>Plex</li>
<li>Nginx</li>
<li>steamcmd</li>
<li>wpa_supplicant (wpa_passphrase)</li>
<li>network_manager (nmcli)</li>
</ul>
<p>Everything should be running via systemd with their logs accessible through journalctl or grafana (if you use loki).</p>
<p>I will write some other entries exploring more in-depth use of this software, this post is just about the initial setup.</p>
<h2 id="related-pages"><a href="#related-pages">Related Pages</a></h2>
<p>I will come back and link to these when I write them.</p>
<ul>
<li>Hosting a static site / Pointing a domain to your self-hosted server</li>
<li>Monitoring Everything In Your Home With Grafana/Prometheus</li>
<li>Nginx and subpath proxy passes</li>
<li>Exposing a development server through your locally hosted server</li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://checkroth.com/tag/linux.html">linux</a>
      <a href="https://checkroth.com/tag/ubuntuserver.html">ubuntuserver</a>
      <a href="https://checkroth.com/tag/selfhosting.html">selfhosting</a>
      <a href="https://checkroth.com/tag/plex.html">plex</a>
      <a href="https://checkroth.com/tag/grafana.html">grafana</a>
      <a href="https://checkroth.com/tag/prometheus.html">prometheus</a>
    </p>
  </div>




    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle ads-responsive"
         data-ad-client="ca-pub-3090577057275093"
         data-ad-slot="6895080254"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'checkroth';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>
  &copy;  2021 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " software-and-stuff ",
  "url" : "https://checkroth.com",
  "image": "/images/me.jpg",
  "description": "Blog and info"
}
</script>

</body>
</html>