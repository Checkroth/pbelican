
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://checkroth.com/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://checkroth.com/theme/pygments/colorful.min.css">
  <link rel="stylesheet" type="text/css" href="https://checkroth.com/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://checkroth.com/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://checkroth.com/theme/font-awesome/css/solid.css">

    <link href="https://checkroth.com/static/custom.css" rel="stylesheet">




<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-136401999-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#FFFFFF">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#FFFFFF">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#FFFFFF">

<meta name="author" content="Charles Heckroth" />
<meta name="description" content="On a project I work on, we frequently struggled with painfully slow queries (tens of seconds to several minutes). The queries were pretty big (aggregation and joins across 10s of tables, some of which with hundreds of thousands of records). Try as we might, we couldn&#39;t speed them up. At …" />
<meta name="keywords" content="postgres, databases">

<meta property="og:site_name" content="software-and-stuff"/>
<meta property="og:title" content="Dead Tuples and Poor Postgres Performance"/>
<meta property="og:description" content="On a project I work on, we frequently struggled with painfully slow queries (tens of seconds to several minutes). The queries were pretty big (aggregation and joins across 10s of tables, some of which with hundreds of thousands of records). Try as we might, we couldn&#39;t speed them up. At …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://checkroth.com/drafts/postgres-garbage.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2022-04-06 00:00:00+09:00"/>
<meta property="article:modified_time" content="2022-04-06 00:00:00+09:00"/>
<meta property="article:author" content="https://checkroth.com/author/charles-heckroth.html">
<meta property="article:section" content="blog"/>
<meta property="article:tag" content="postgres"/>
<meta property="article:tag" content="databases"/>
<meta property="og:image" content="/images/me2.jpeg">

  <title>software-and-stuff &ndash; Dead Tuples and Poor Postgres Performance</title>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-3090577057275093",
      enable_page_level_ads: true
    });
  </script>
</head>
<body>
  <aside>
    <div>
      <a href="https://checkroth.com">
        <img src="/images/me2.jpeg" alt="Charles Henry Heckroth" title="Charles Henry Heckroth">
      </a>
      <h1><a href="https://checkroth.com">Charles Henry Heckroth</a></h1>

<p>My Notes & Blog</p>
      <nav>
        <ul class="list">
          <li><a href="https://checkroth.com/pages/about-me.html">About Me</a></li>

          <li><a href="https://checkroth.com/category/blog.html" target="_blank">Blog</a></li>
          <li><a href="https://drive.google.com/file/d/1T80kxtu-rTTqWSHAqkLZAsEqcBnmXwFK/view?usp=sharing" target="_blank">Resume</a></li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-envelope" href="mailto:checkroth@gmail.com" target="_blank">
            <i class="fas fa-envelope">
            </i>
          </a></li>
          <li>
            <a  class="sc-github" href="https://www.github.com/Checkroth" target="_blank">
            <i class="fab fa-github">
            </i>
          </a></li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/charlesheckroth" target="_blank">
            <i class="fab fa-linkedin">
            </i>
          </a></li>
          <li>
            <a  class="sc-twitter" href="http://www.twitter.com/checkroth" target="_blank">
            <i class="fab fa-twitter">
            </i>
          </a></li>
          <li>
            <a  class="sc-stack-overflow" href="https://stackoverflow.com/users/1037971/charles" target="_blank">
            <i class="fab fa-stack-overflow">
            </i>
          </a></li>
      </ul>
    </div>

      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <ins class="adsbygoogle ads-aside"
           data-ad-client="ca-pub-3090577057275093"
           data-ad-slot="7734708573"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>

  </aside>
  <main>

    <nav>
      <a href="https://checkroth.com">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="postgres-garbage">Dead Tuples and Poor Postgres Performance</h1>
    <p>
          Posted on April 06, 2022 in <a href="https://checkroth.com/category/blog.html">blog</a>


    </p>
  </header>


  <div>
    <p>On a project I work on, we frequently struggled with painfully slow queries (tens of seconds to several minutes). The queries were pretty big (aggregation and joins across 10s of tables, some of which with hundreds of thousands of records). Try as we might, we couldn't speed them up.</p>
<p>At one point it got so bad (through a series of misguided implementation choices) that I took down our production environment by eating up all the available connections on our postgrse instance (many untenably slow queries running in unison with no end in sight).</p>
<p>Ultimately, we were able to reduce query times from ~30+ seconds to ~20ms by manually running garbage collection. Which we really shouldn't need to do. This post is going to talk about</p>
<ul>
<li>The origin of the problem</li>
<li>The long-term solution</li>
<li>The lessons learned / things to look out for so it doesn't happen again</li>
</ul>
<h1 id="the-problem">The Problem</h1>
<p>The surface level problem is obviously that our tables are big and bloated, filled with god knows what data from years ago.</p>
<p>The real issue however is that postgres <em>should</em> be cleaning this up itself, and it isn't. But <em>why</em>?</p>
<h1 id="the-solution">The Solution</h1>
<p>Occasionally running manual the postgres analyzer and vacuum by hand is <em>not</em> a solution.
The long term solution is to fix whatever was preventing these things from running on their own. We never messed with our postgres configuration, and by default it should be regularly cleaning this stuff up on its own.</p>
<h1 id="how-to-make-my-stuff-work-more-good">How to make my stuff work more good</h1>
<h1 id="sources">Sources</h1>
<ul>
<li><a href="https://www.cybertec-postgresql.com/en/reasons-why-vacuum-wont-remove-dead-rows/">Reasons Why Vacuum Won't Remove Dead Code, Laurenz Albe, cybertec-postgresql</a></li>
<li><a href="https://www.cybertec-postgresql.com/en/stale-statistics-cause-table-bloat/">Stale Statistics Cause Table Bloat, Laurenz Albe, cybertec-postgresql</a></li>
<li><a href="https://aws.amazon.com/blogs/database/understanding-autovacuum-in-amazon-rds-for-postgresql-environments/">Understanding Autovacuum in Amazon RDS for Postgresql Environments, Anuraag Deekonda and Baji Shaik, aws</a></li>
<li><a href="https://www.2ndquadrant.com/en/blog/when-autovacuum-does-not-vacuum/">Trouble with Autoanalyze, Tomas Vondra, 2ndquadrant</a></li>
<li><a href="https://www.2ndquadrant.com/en/blog/autovacuum-tuning-basics/"></a></li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://checkroth.com/tag/postgres.html">postgres</a>
      <a href="https://checkroth.com/tag/databases.html">databases</a>
    </p>
  </div>




    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle ads-responsive"
         data-ad-client="ca-pub-3090577057275093"
         data-ad-slot="6895080254"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'checkroth';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>
  &copy;  2021 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " software-and-stuff ",
  "url" : "https://checkroth.com",
  "image": "/images/me2.jpeg",
  "description": "Blog and info"
}
</script>

</body>
</html>