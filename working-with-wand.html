<!DOCTYPE html>
<html lang="en">
<head>
          <title>checkroth-site - Working with ImageMagick's Wand Python Library</title>
        <meta charset="utf-8" />




    <meta name="tags" content="python" />
    <meta name="tags" content="python-wand" />
    <meta name="tags" content="pdf" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">checkroth-site <strong>My Notes & Blog</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/blog_index.html">Blog</a></li>
            <li><a href="/archives.html">Archives</a></li>
            <li><a href="/categories.html">Categories</a></li>
            <li><a href="/tags.html">Tags</a></li>
            <li><a href="/">About Me</a></li>
            <li class="active"><a href="/category/blog.html">blog</a></li>
            <li><a href="/category/software-blog.html">software blog</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="/working-with-wand.html" rel="bookmark"
         title="Permalink to Working with ImageMagick's Wand Python Library">Working with ImageMagick's Wand Python Library</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2019-03-19T00:00:00+09:00">
      March 19, 2019
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="/author/charles-heckroth.html">Charles Heckroth</a>
    </address>
    <div class="category">
        Category: <a href="/category/blog.html">blog</a>
    </div>
    <div class="tags">
        Tags:
            <a href="/tag/python.html">python</a>
            <a href="/tag/python-wand.html">python-wand</a>
            <a href="/tag/pdf.html">pdf</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>Handling images in wand can be deviously tricky, especially when you need a common system-wide resolution.</p>
<p>An example use-case:</p>
<p>I work on a system that sends &amp; receives faxes. It also handles email attachments and draws text on to fixed format images (inquiries, order details, etc.).</p>
<p>Due to the fact that we're writing in to fixed formats with wand, and also writing on top of faxes and sending faxes (through Twilio), a system-wide fixed resolution makes things a lot easier.</p>
<p>I frequently experience issues with font and draw position scaling, particularly when writing on PDFs.</p>
<p>When I reference <code>pdf.pdf</code>, I am specifically referencing <a href="http://www.pdf995.com/samples/pdf.pdf">this document</a>.</p>
<h1>Getting the Resolution</h1>
<p>An image file has some resolution metadata attached to it.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">wand.image</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="k">with</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;myfile.png&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
    <span class="n">image</span><span class="o">.</span><span class="n">resolution</span>

<span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
</pre></div>


<p>You can also specify a resolution when opening it in Wand, and it will scale it for you</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">wand.image</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="k">with</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;myfile.png&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
    <span class="n">image</span><span class="o">.</span><span class="n">resolution</span>

<span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>


<p>This works fine for regular images, but it's a bit tricky with PDFs.</p>
<h1>Dealing with PDFs</h1>
<h2>PDF Resolutions</h2>
<p>The first thing to note with a PDF is that wand will <em>not</em> open it in its original resolution.</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;pdf.pdf&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
    <span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
<span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">72</span><span class="p">,</span> <span class="mi">72</span><span class="p">)</span>
</pre></div>


<p>A PDF opened in wand will always be at a resolution of 72. A PDF <em>created</em> in wand will <em>also</em> always have a resolution of 72. If you want to do any remotely complex image processing on a PDF with Wand, you must always specify a resolution or you will run in to a lot of issues. The biggest being that every time you open and save the PDF, its quality will reduce dramatically (if its original resolution was greater than the default 72).</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;pdf.pdf&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
    <span class="n">image</span><span class="o">.</span><span class="n">resolution</span>
<span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>


<p>Specifying the resolution when opening the pdf will work as expected.</p>
<p>Creating a new pdf works the same, which can actually be quite confusing.</p>
<h2>Wand-created PDF Resolutions</h2>
<p>Say you want to create a new PDF. You want it to be in Letter size, so you program assuming the PDF is at the default resolution, and then scale all of your widths, heights, and coordinates up to your system-wide resolution.</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Image</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
    <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;test_pdf.pdf&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;test_pdf.pdf&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="k">as</span> <span class="n">i</span><span class="p">:</span>
    <span class="n">i</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">height</span>

<span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">1389</span><span class="p">,</span> <span class="mi">1389</span><span class="p">)</span>
</pre></div>


<p>If you're scaling your sizes and positions when creating your pdf, re-opening at the resolution you have specified is going to explode its size significantly.</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Image</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
    <span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;test_pdf.pdf&#39;</span><span class="p">)</span>


<span class="k">with</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;test_pdf.pdf&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">i</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">height</span>

<span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
</pre></div>


<p>It is important to specify the resolution <em>before</em> saving the PDF or doing any drawing operations.</p>
<p>It is also important to note that creating a new PDF at a certain resolution will <em>not</em> work if you pass the resolution in the constructor. I'm not really sure why, but the above code will work while <code>Image(width=500, height=500, resolution=200)</code> will reproduce the original resolution explosion issue.</p>
<h1>Image Units</h1>
<p>Wand has three units of measurement.</p>
<ul>
<li><code>undefined</code></li>
<li><code>pixelsperinch</code></li>
<li><code>pixelspercentimeter</code></li>
</ul>
<p>PDFs are undefined by default. They don't hold the metadata like a <code>png</code>, <code>tiff</code>, etc. What <code>undefined</code> means is determined by ImageMagick itself, which probably references something in the operating system.</p>
<p>In my personal experience, <code>undefined</code> has always calculated as <code>pixelsperinch</code>, but it may be different on other operating systems or environments. It's best to specify a system-wide unit and use it whenever you open an image.</p>
<h2>Magic Units</h2>
<p>I used magic units for some time (leaving everything as <code>undefined</code>). Then one day, we decided to change our Twilio settings to send us images as Tiffs instead of PDFs.</p>
<p>As it turns out, Tiff actually has the unit metadata, and it was set to <code>pixelspercentimeter</code>. Everything we received after that change was completely incorrectly processed because we had until that point processed everything as <code>undefined</code> or <code>pixelsperinch</code>.</p>
<h1>Pitfall: Resizing</h1>
<p>Resizing very handy. Especially in the previous example of receiving Tiffs from Twilio.</p>
<p>A fun side-note: Faxes can be sent with different quality levels: Normal, Fine, and Superfine. These qualities actually only increase the vertical axis. When twilio sends you a PDF it transforms it to its intended aspect ratio for you, but a Tiff is the raw data. Normal will be flag, Fine will be the right ratio, and Superfine will be incredibly tall.</p>
<p>To deal with this, I had to resize the Tiff before saving it so we could process it normally. For instance, for a <code>normal</code> quality fax:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;received.tiff) as image:</span>
    <span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;resized_image.tiff&#39;</span><span class="p">)</span>
</pre></div>


<p>The problem here is that resizing an image in wand has no impact on its resolution.</p>
<p>Meaning, if you had a resolution of <code>(100, 200)</code> and resized it as specified above, the resolution will not become <code>(200, 200)</code>, but remain the same. Then the next time you open it, things are going to get <em>really weird</em>.</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;received.tiff) as image:</span>
    <span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;resized_image.tiff&#39;</span><span class="p">)</span>
</pre></div>


<p>would appropriately resize the image and its resolution.</p>
<h1>Pitfall: Sequences</h1>
<p>Wand drawings aren't exactly meant for PDFs or layered images. Neither is the resize utility, or really anything else.</p>
<p>Wand images have a <code>sequence</code> attribute, which is crucial.</p>
<p>You might think that if you do <code>draw(image)</code> with wand, you would write on the first page of the PDF. It will draw it on the last page.</p>
<p>Wand has an <code>index_context</code> to deal with this:</p>
<div class="highlight"><pre><span></span><span class="c1"># assuming your draw attribute is created already</span>
<span class="k">with</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;pdf.pdf&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">image</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">index_context</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">draw</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</pre></div>


<p>This will draw on the first page. Changing the integer you pass in to index_context will change the page you draw on, just like any iterable in python (or any other language).</p>
<h1>Pitfall: Coding for Low Resolutions and Scaling Up</h1>
<p>When I started out, I coded all of my text-writing-on-pdf stuff with the default resolution, because I didn't really understand anything I've written up to this point (it was a learning process.)</p>
<p>Wand hates floats and doubles. Font sizes, positions, widths, heights, and everything else is restricted to integers.</p>
<p>If you program pdf writing assuming the resolution is 72 and then scale up, the higher you go the more off things are going to be. If you start high and go low, things will be a lot more accurate.</p>
<p>72 is in general way too low quality for PDF processing and you'll probably be using at least 150 or 200, so you should probably start out the gate assuming your pdfs are that resolution to avoid rounding errors.</p>
<h1>Pitfall: Colorspaces</h1>
<p>You can't write on a CMYK colorspace. If you try, you'll write on a different layer. White will become black and black will become white, and other things will become other things. It's a huge headache.</p>
<p>My advice is to turn around and quit as soon as you see CMYK, but that's obviously not an option all the time.</p>
<p>To deal with CMYK, the best you can do is something like this:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;cmyk_pdf.pdf&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
    <span class="n">original_colorspace</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">colorspace</span>
    <span class="k">if</span> <span class="n">original_colorspace</span> <span class="o">=</span> <span class="s1">&#39;cmyk&#39;</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">image</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">index_context</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># or whatever page / pages you&#39;re processing</span>
            <span class="n">image</span><span class="o">.</span><span class="n">transform_colorspace</span><span class="p">(</span><span class="s1">&#39;srgb&#39;</span><span class="p">)</span>
    <span class="n">draw</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  <span class="c1"># do all your drawing now</span>
    <span class="n">image</span><span class="o">.</span><span class="n">transform_colorspace</span><span class="p">(</span><span class="n">original_colorspace</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;cmyk_drawn_pdf.pdf&#39;</span><span class="p">)</span>
</pre></div>


<p>You'll probably still encounter some issues, but if you're going to draw on a cmyk pdf this is the best solution I've come up with.</p>
<h1>Pitfall: Wand Scope</h1>
<p>Wand eats your memory. All of my code examples have <code>with Image() as image):</code> to keep the image file in context.</p>
<p>If you do <code>i = Image()</code>, then you need to call <code>i.close()</code> when you're done with it.</p>
<p>If you're working on a large system, its best to avoid passing around Image instances and to localize it all to one module.</p>
<p>Colors, Drawings, and all other Wand objects should also be handled within a <code>with</code> context.</p>
<h1>Notes</h1>
<p>1: I am not primarily an engineer who deals with images, so some of my understanding could be wrong (the code works,  but the underlying reasons could be different from my current understanding)</p>
<p>2: I mention scaling a few times. </p>
<p>I generally scale positions and sizes with <code>math.floor(value * (SYSTEM_RESOLUTION / IMPLEMENTATION_RESOLUTION))</code>, where <code>SYSTEM_RESOLUTION</code> is the resolution you want, <code>IMPLEMENTATION_RESOLUTION</code> is whatever resolution you assumed when writing the code, and <code>value</code> is the value you want to scale.</p>
<p>3: Making an new image: I generally call this a <code>canvas</code>, and its important to specify the background color if you're going to be creating some sort of business document with the <code>background</code> parameter to the <code>Image</code> constructor.</p>
<p>4: Wand uses ImageMagick to process everything, so outside of the wand version (I'm using <code>0.4.4</code>), your operating system and ImageMagick version could also make things work differently.</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>