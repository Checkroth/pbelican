
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="/theme/pygments/colorful.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/solid.css">

    <link href="/static/custom.css" rel="stylesheet">




<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-136401999-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#FFFFFF">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#FFFFFF">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#FFFFFF">

<meta name="author" content="Charles Heckroth" />
<meta name="description" content="Stripping passwords from files in Python" />
<meta name="keywords" content="python, pdf, msoffcrypto-tool, pikepdf">

<meta property="og:site_name" content="checkroth-site"/>
<meta property="og:title" content="Password Protected Files in Python"/>
<meta property="og:description" content="Stripping passwords from files in Python"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/unlocking-password-protected-files.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-04-12 00:00:00+09:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/charles-heckroth.html">
<meta property="article:section" content="blog"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="pdf"/>
<meta property="article:tag" content="msoffcrypto-tool"/>
<meta property="article:tag" content="pikepdf"/>
<meta property="og:image" content="/images/me.jpg">

  <title>checkroth-site &ndash; Password Protected Files in Python</title>

</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/images/me.jpg" alt="Charles Henry Heckroth" title="Charles Henry Heckroth">
      </a>
      <h1><a href="">Charles Henry Heckroth</a></h1>

<p>My Notes & Blog</p>
      <nav>
        <ul class="list">
          <li><a href="/#about-me">About Me</a></li>

          <li><a href="/blog_index.html" target="_blank">Blog</a></li>
          <li><a href="https://drive.google.com/file/d/1HLklPEKD8CMGnUfddLsOewxYlIfioJxq/view" target="_blank">Resume</a></li>
          <li><a href="https://www.beproud.jp" target="_blank">BeProud</a></li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-envelope" href="mailto:checkroth@gmail.com" target="_blank">
            <i class="fas fa-envelope">
            </i>
          </a></li>
          <li>
            <a  class="sc-github" href="https://www.github.com/Checkroth" target="_blank">
            <i class="fab fa-github">
            </i>
          </a></li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/charlesheckroth" target="_blank">
            <i class="fab fa-linkedin">
            </i>
          </a></li>
          <li>
            <a  class="sc-twitter" href="http://www.twitter.com/checkroth" target="_blank">
            <i class="fab fa-twitter">
            </i>
          </a></li>
          <li>
            <a  class="sc-stack-overflow" href="https://stackoverflow.com/users/1037971/charles" target="_blank">
            <i class="fab fa-stack-overflow">
            </i>
          </a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="">    Home
</a>

      <a href="/blog_index.html">Blog</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="unlocking-password-protected-files">Password Protected Files in Python</h1>
    <p>
          Posted on April 12, 2019 in <a href="/category/blog.html">blog</a>


    </p>
  </header>


  <div>
    <p>When working on a system that processes files, you're likely to run in to password protected files. Particularly in Japan, password-protected pdfs, office files, and zip files are the norm.</p>
<p>I turn down feature requests for zip files due to the possibility of them containing an undefined nested directory structure that would be a lot more work than its worth to deal with. So I have no thoughts on dealing with those in python, though <a href="https://docs.python.org/3/library/zipfile.html">python's zipfile module</a> would almost certainly do the trick.</p>
<p>PDFs and Office Files are a different issue. I use <a href="https://github.com/pikepdf/pikepdf">pikepdf</a> for pdf processing and <a href="https://github.com/nolze/msoffcrypto-tool">msoffcrypto-tool</a> for office file processing.</p>
<h1>PDFs and PikePDF</h1>
<p>Pikepdf is really, really simple.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pikepdf</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="n">encrypted_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;myfile.pdf&#39;</span><span class="p">)</span>
<span class="n">decrypted_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;pikepdf_output.pdf&#39;</span><span class="p">)</span>
<span class="n">pikepdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encrypted_file</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;my_password&#39;</span><span class="p">)</span>
<span class="n">pikepdf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">decrypted_file</span><span class="p">)</span>
</pre></div>


<p>And that's it! Mostly.</p>
<p>There are three minor points to address:</p>
<ul>
<li>Pikepdf will throw errors on decryption</li>
<li>Pikepdf will not error if you input a password for a file that isn't password-protected</li>
<li>Pikepdf will not be able to directly overwrite the pdf with its decrypted version</li>
</ul>
<h2>Handling the errors</h2>
<p>Pikepdf will throw errors if you have:</p>
<ul>
<li>A file that isn't a pdf</li>
<li>A broken pdf</li>
<li>The wrong password</li>
</ul>
<p>Handling each case is also incredibly simple.</p>
<div class="highlight"><pre><span></span><span class="n">encrypted_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;myfile.pdf&#39;</span><span class="p">)</span>
<span class="n">decrypted_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;pikepdf_output.pdf&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">pikepdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encrypted_file</span><span class="p">,</span> <span class="s1">&#39;my_password&#39;</span><span class="p">)</span>
    <span class="n">pikepdf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">decrypted_file</span><span class="p">)</span>
<span class="k">except</span> <span class="n">pikepdf</span><span class="o">.</span><span class="n">PdfError</span><span class="p">:</span>
    <span class="c1"># A file that isn&#39;t a pdf</span>
    <span class="c1"># A broken pdf</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Do something with your not-a-pdf&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">pikepdf</span><span class="o">.</span><span class="n">PasswordError</span><span class="p">:</span>
    <span class="c1"># The wrong password</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Do something with your password-encrypted pdf that you failed to decrypt&#39;</span><span class="p">)</span>
</pre></div>


<p>The errors are very simple. A PdfError if Pikepdf couldn't open the file (this is unrelated to encryption itself), and a PasswordError if your password was wrong.</p>
<h2>Finding out if a file is encrypted</h2>
<p>Pike pdf will <em>not</em> throw an error if you put in a password for a pdf that has no password. It will just open the file normally.</p>
<p>This is never really an issue, but you might find yourself in a situation where you need to see if a pdf has a password or not.</p>
<p>For instance, maybe you have a password unlock feature in your application. You don't have any passwords when you initially store the PDF, but you do need to flag it as password-protected or not, so your users know if they need to unlock it or not.</p>
<div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">pikepdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;maybe_encrypted_file.pdf&#39;</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">pdf</span>
    <span class="k">return</span> <span class="s1">&#39;Not encrypted!&#39;</span>
<span class="k">except</span> <span class="n">pikepdf</span><span class="o">.</span><span class="n">PasswordError</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;Encrypted!&#39;</span>
</pre></div>


<p>The PasswordError will be thrown if you <em>don't</em> supply a password to a pdf that is password protected. If you throw a password in and don't get a password error, you don't know if it was initially encrypted or not.</p>
<h3>del pdf?????</h3>
<p><code>del pdf</code> is actually unnecessary, but <a href="https://github.com/pikepdf/pikepdf/issues/37">PikePDF will not automatically close the os handler in some cases</a>. Most people don't really have to worry about this, but if you have a high traffic service that uses pikepdf heavily and is not often restarted you may run in to a "Too many open files" error after some time. <code>del pdf</code> will delete the variable and its related os handler.</p>
<h2>Overwriting your pdf with pikepdf</h2>
<p>Long story short: You can't do it. Save your decrypted file as a separate pdf, and then use <code>shutil</code> to move it over the original file.</p>
<div class="highlight"><pre><span></span><span class="n">encrypted_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;myfile.pdf&#39;</span><span class="p">)</span>
<span class="n">decrypted_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;pikepdf_output.pdf&#39;</span><span class="p">)</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="n">pikepdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encrypted_file</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;mypassword&#39;</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">decrypted_file</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">decrypted_file</span><span class="p">,</span> <span class="n">encrypted_file</span><span class="p">)</span>
</pre></div>


<p>It's not pretty, but it works.</p>
<h1>Office Files and msoffcrypto-tool</h1>
<p>Msoffcrypto-tool is a bit more complicated than pikepdf.</p>
<ul>
<li>Office 97~2004 XLS files are not supported for decryption.</li>
<li>Each file type and office version will have a different impact on how msoffcrypto tool fails</li>
<li>msoffcrypto throws generic python errors<ul>
<li><code>OSError</code>: Not an office file</li>
<li><code>AssertionError</code>: Office 97~2004 wrong password input</li>
<li><code>Exception</code>: Non-encrypted xls file, OR wrong password input on decrypt</li>
<li><code>error</code>: Correct password on encrypted office 97~2004 xls file</li>
</ul>
</li>
</ul>
<p>Its a lot to take in, so I'm just going to put my full code for decrypting an office file when you don't know what kind of office file it is.</p>
<div class="highlight"><pre><span></span><span class="c1"># Open the file</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">msoffcrypto</span>

<span class="n">full_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;input_file.docx&#39;</span><span class="p">)</span>
<span class="n">out_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;output_file.docx&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">office_in</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load it in to msoffcrypto</span>
        <span class="n">office_file</span> <span class="o">=</span> <span class="n">msoffcrypto</span><span class="o">.</span><span class="n">OfficeFile</span><span class="p">(</span><span class="n">office_in</span><span class="p">)</span>
        <span class="n">office_file</span><span class="o">.</span><span class="n">load_key</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="c1"># OSError will be thrown if you passed in a file that isn&#39;t an office file</span>
        <span class="k">return</span> <span class="s1">&#39;not an office file&#39;</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="c1"># Office 97~2004 files only:</span>
        <span class="c1"># AssertionError will be thrown on load_key if the password is wrong</span>
        <span class="k">return</span> <span class="s1">&#39;wrong password&#39;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># xls files only:</span>
        <span class="c1"># msoffcrypto will throw a generic Exception on load_key if the file isn&#39;t encrypted</span>
        <span class="k">raise</span> <span class="s1">&#39;not encrypted&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">office_file</span><span class="o">.</span><span class="n">is_encrypted</span><span class="p">():</span>
        <span class="c1"># Other than xls files, you can check if a file is encrypted with the .is_encrypted function</span>
        <span class="k">raise</span> <span class="s1">&#39;not encrypted&#39;</span>

    <span class="c1"># Open your desired output as a file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">office_out</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># load_key just inputs a password; you need to call decrypt to actually decrypt it.</span>
            <span class="n">office_file</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">office_out</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">error</span><span class="p">:</span>
            <span class="c1"># Office 97~2003 Only: These files aren&#39;t supported yet.</span>
            <span class="c1"># If the password is CORRECT, msoffcrypto will through a generic &#39;error&#39;</span>
            <span class="k">raise</span> <span class="s1">&#39;encrypted, but decryption not supported&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Finally, msoffcrypto will throw a generic Exception on decrypt if the password is wrong</span>
            <span class="k">return</span> <span class="s1">&#39;wrong password</span>

    <span class="c1"># just like pikepdf, you can&#39;t write over the file you&#39;re reading.</span>
    <span class="c1"># If you want to overwrite it, you must save it separately and then move it</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
</pre></div>


<p>The core steps to unlocking an office file are:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">office_in</span><span class="p">:</span>
    <span class="c1"># Open the file</span>
    <span class="n">office_file</span> <span class="o">=</span> <span class="n">msoffcrypto</span><span class="o">.</span><span class="n">OfficeFile</span><span class="p">(</span><span class="n">office_in</span><span class="p">)</span>
    <span class="c1"># Input the password</span>
    <span class="n">office_file</span> <span class="o">=</span> <span class="n">msoffcrypto</span><span class="o">.</span><span class="n">load_key</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="s1">&#39;mypassword&#39;</span><span class="p">)</span>

    <span class="c1"># open the output</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">office_out</span><span class="p">:</span>
        <span class="c1"># Run decrypt. This will write to the output file.</span>
        <span class="n">office_file</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">office_out</span><span class="p">)</span>
</pre></div>


<p>But there are a <em>lot</em> of things that can go wrong here, so the try-catch statements above are a must if you want any sense of stability.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/python.html">python</a>
      <a href="/tag/pdf.html">pdf</a>
      <a href="/tag/msoffcrypto-tool.html">msoffcrypto-tool</a>
      <a href="/tag/pikepdf.html">pikepdf</a>
    </p>
  </div>





<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'checkroth';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>
  &copy;  2019 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " checkroth-site ",
  "url" : "",
  "image": "/images/me.jpg",
  "description": "My Blog"
}
</script>

</body>
</html>